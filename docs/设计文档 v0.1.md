#【功能设计】

## 用户

### 1. 用户注册

填写邮箱，用户名，密码，昵称

**说明：**

* 用户名长度为 5 到 18，组成符号可以是大小写不敏感的英文字母、数字、下划线。第一位字符必须是英文符号，下划线不能出现在开头或结尾。
* 密码长度为 6 到 32 位。
* 注册时填写的登陆邮箱暂时不做验证，但是预留了一个字段（email\_is\_varified），今后会加入验证的。今后也可以考虑用户修改自己的登陆邮箱。

### 2. 用户登录

使用邮箱/用户名 + 密码登录，登陆不使用验证码。

### 3. 用户主页

* 用户主页显示用户基本信息。 第一版中不支持上传头像，前端使用固定的图片做展示
* 可以查看用户的问题和回答
* 登录用户可以查看自己收藏的问题和回答
* 登录用户可以修改资料。详细资料包括 昵称，性别，生日，位置，网站，个人简介
* 登录用户可以修改密码

### 4. 用户列表

* 显示声望最高的的用户列表。第一版中用户每次提问和回答都计算一点声望
* 显示最新注册的用户列表

### 5. 用户状态

* 删除的用户。无法登录，删除用户后还保留用户的提问和回答
* 禁用的用户。只能够管理用户收藏，不能够进行提问、回答、投票操作

#### 讨论:  

* 声望的算法
* 删除后的用户的显示，如显示为 `Guest` 用户
* 对新注册用户提问和回答的限制

## 问题

### 1. 问题列表

问题列表包含以下几个标签页：

* 新鲜（fresh）：按最后“激活”时间（last\_refreshed\_at，问题的添加时间或最后回答时间）倒序
* 热门（hot）：按热门指数（比如：浏览次数 + 投票次数）倒序排列
* 尚未回答（unanswered）：没有回答的问题按照热门指数来倒序排列

排序规则很多，但是目前只支持这三个规则，今后根据使用情况调整。

### 2. 提问

填写问题的标题和内容，可以为问题添加标签。

### 3. 修改问题

用户可以修改自己提出的问题

### 4. 关闭问题

* 管理员可以关闭问题
* 问题列表中关闭的问题排列在未关闭问题之后

### 5. 删除问题

* 用户可以删除自己提出的问题
* 管理员可以恢复被删除的问题（用户、问题、回答的删除实现上只是加了一个删除标记）


## 标签

* 主页显示使用次数最多的前 20 个标签
* 可以查看标签列表，按照使用次数排序
* 标签可以加入说明和图标，图标由管理员在后台添加
* 可以查看标签下的所有问题列表
* 登录用户可以为问题添加标签
* 管理员可以删除标签

**说明：**  
* 类似标签的合并，和标签的层次暂时不考虑。

### 讨论:

* 相似标签的合并，如 `sublime-text` 和 `sublime text`
* 子标签，如 `jQuery` 和  `jQuery1.6`

## 回答

* 登录用户可以回答问题
* 登录用户修改和删除自己的回答
* 登录用户可以赞成/反对一个非自己的回答
* 回答默认按照投票（赞成-反对）排序，可以选择按照回答时间排序

**讨论：**  
最终投票的排序问题，如问题 A 的赞成 100 反对 99，问题 B 赞成 2 反对 0，虽然 2 - 0 > 100 - 99 但是 A 的活跃度也不能忽视，目前暂定直接减。

## 评论

* 登录用户可以对回答发表简短的评论
* 登录用户修改和删除自己的评论

## 收藏

登录用户可以收藏问题和回答，在登录用户的主页查看收藏的问题和回答  
**说明：**  
不是关注，更加类似于 Mark，所以英文是用的 Mark 这个单词，就是标记一下而已，所以没有加入对标签和用户的关注，也不会收到问题，回答的新动态。

## 搜索

* 支持搜索标签下的问题
* 支持以空格隔开的关键字搜索

## 管理后台

* 问题管理：修改问题，删除问题，恢复删除的问题，删除问题的标签
* 回答管理：修改回答，删除回答，恢复删除的回答
* 评论管理：修改评论，删除评论，恢复删除的回答
* 用户管理：修改用户组（包含管理员和普通用户），禁用和激活用户，修改用户资料，删除用户
* 标签管理：修改标签名称， 删除标签，添加说明，添加图标

# 【数据库设计】 #

**说明**

1. 后端会使用以下第三方应用：
 - django.contrib.auth
 - django.contrib.comment
 - django.contrib.contenttypes
 - django.contrib.session
 - django.contrib.messages
 - django-notifications-hp
2. 模型全部用单数，表名使用 Django 规则。

## 用户信息 UserProfile

1. **user** `ForeignKey`(`User`) 用户ID，也是 `PrimaryKey`
1. nickname `Char` 昵称
1. birthday `Date` 生日
1. location `Char` 位置
1. gender `Char` 性别
1. reputation `Integer` 声望，统计提问和回答的次数用于用户列表的排序
1. about `Text` 个人简介
1. website `Char` 网站
1. email_is_varified `Boolean` 邮箱是否已经验证

## 问题 Question

1. **id** `PrimaryKey`
1. title `Char` 问题
1. content `Text` 问题说明
1. *tags* `ManyToMany`(`Tag`)
1. created_by `ForeignKey`(`User`) 创建人
1. created_at `Datetime` 创建时间
1. *last\_updated\_by* `ForeignKey`(`User`) 最后更新用户 
1. last\_updated\_at `Datetime` 最后更新时间
1. *last\_refreshed\_by* `ForeignKey`(`User`) 最后活跃（回答、投票）用户
1. last\_refreshed\_at `Datetime` 最后活跃（回答、投票）时间
1. view_count `Integer` 浏览次数
1. answer_count `Integer` 回答次数
1. up_count `Integer` 支持数
1. down_count `Integer` 反对数
1. comment_count `Integer` 评论数
1. mark_count `Integer` 收藏数
1. ranking_weight `Integer` 排序权重
1. closed `Boolean` 是否被管理员关闭
1. deleted `Boolean` 是否被删除

## 标签 Tag

1. **id** `PrimaryKey`
1. name `Char` 名称
1. **master** `ForeignKey`(`Tag`) 主标签，用于标签合并 *暂时不用*
1. **parent** `ForeignKey`(`Tag`) 上级标签，用于标签分层
1. level `Integer` 标签层次
1. icon `Char` 标签图标（URL）
1. description `Char` 描述
1. used_count `Integer` 使用次数
1. deleted `Boolean` 是否被删除
1. **created_by** `ForeignKey`(`User`) 创建人
1. created_at `Datetime` 创建时间

## 答案 Answer

1. **id** `PrimaryKey`
1. **question** `ForeignKey`(`Quetion`) 问题
1. content `Text` 回答正文
1. **created_by** `ForeignKey`(`User`) 创建人
1. created_at `Datetime` 创建时间
1. **last\_updated\_by** `ForeignKey`(`User`) 最后更新用户 
1. last\_updated\_at `Datetime` 最后更新时间
1. up_count `Integer` 支持数
1. down_count `Integer` 反对数
1. comment_count `Integer` 评论数
1. mark_count `Integer` 收藏数
1. ranking_weight `Integer` 排序权重
1. deleted `Boolean` 是否被删除

## 投票 Vote

1. **id** `PrimaryKey`
2. **content_type** `ForeignKey`(`ContentType`)
3. object_pk `Char`
4. value `Integer` 值，赞成为 1, 反对为 -1
5. **voted_by** `ForeignKey`(`User`) 投票人
6. voted_at `Datetime` 投票时间

## 收藏 Mark

1. **id** `PrimaryKey`
2. **content_type** `ForeignKey`(`ContentType`)
3. object_pk `Char`
4. tags `Char` 标签，方便管理收藏夹 *暂时不用*
5. **favorited_by** `ForeignKey`(`User`) 收藏人
6. favorited_at `Datetime` 收藏时间
